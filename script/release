#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

cd "$(dirname "$0")/.."

# Run checks, bump version. Create a commit, tag and push.
yarn np \
  --test-script checks \
  --no-release-draft \
  --no-publish

# Build artifacts.
yarn bundle:chrome
yarn bundle:firefox

# Create a GitHub release, upload build artifacts.
tag=$(git describe --abbrev=0 --tags)
gh release create "$tag" \
  --generate-notes \
  --verify-tag \
  ./dist/*.zip

# Mozilla Add-Ons
read -rp "Please provide your Mozilla API Key: " apikey
read -srp "Please provide the corresponding API Secret: " apisecret
printf "\n\n"

# Chrome Web Store
read -rp "Please provide your Chrome Web Store Publish API client ID: " client_id
read -srp "Please provide your Chrome Web Store Publish API client secret: " client_secret
printf "\n"
read -srp "Please provide your Chrome Web Store Publish API refresh token: " refresh_token
printf "\n\n"

yarn web-ext sign \
  --api-key "$apikey" \
  --api-secret "$apisecret" \
  --source-dir ./dist/firefox \
  --use-submission-api \
  --channel=listed

printf "\n\n"

gh release upload \
  "$tag" \
  "web-ext-artifacts/tickety_tick-${tag##v}.xpi"

printf "\n\n"

yarn chrome-webstore-upload upload \
  --client-id "$client_id" \
  --client-secret "$client_secret" \
  --refresh-token "$refresh_token" \
  --extension-id "ciakolhgmfijpjbpcofoalfjiladihbg" \
  --auto-publish \
  --source ./dist/chrome.zip

cat <<EOS
Edit the auto-generated release notes on GitHub as necessary:
https://github.com/bitcrowd/tickety-tick/releases/tag/$tag

Do not forget to upload a source code archive for the new release here:
https://addons.mozilla.org/developers/addon/tickety-tick/versions

You can grab a source code archive here:
https://github.com/bitcrowd/tickety-tick/releases/tag/$tag
EOS
